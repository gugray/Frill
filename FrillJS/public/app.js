"use strict";!function e(t,n,o){function c(r,a){if(!n[r]){if(!t[r]){var s="function"==typeof require&&require;if(!a&&s)return s(r,!0);if(i)return i(r,!0);var d=new Error("Cannot find module '"+r+"'");throw d.code="MODULE_NOT_FOUND",d}var l=n[r]={exports:{}};t[r][0].call(l.exports,function(e){var n=t[r][1][e];return c(n||e)},l,l.exports,e,t,n,o)}return n[r].exports}for(var i="function"==typeof require&&require,r=0;r<o.length;r++)c(o[r]);return c}({1:[function(e,t,n){!function(e,n){"function"==typeof define&&define.amd?define([],n):void 0!==t&&t.exports?t.exports=n():e.ReconnectingWebSocket=n()}(this,function(){function e(t,n,o){function c(e,t){var n=document.createEvent("CustomEvent");return n.initCustomEvent(e,!1,!1,t),n}var i={debug:!1,automaticOpen:!0,reconnectInterval:1e3,maxReconnectInterval:3e4,reconnectDecay:1.5,timeoutInterval:2e3,maxReconnectAttempts:null};o||(o={});for(var r in i)void 0!==o[r]?this[r]=o[r]:this[r]=i[r];this.url=t,this.reconnectAttempts=0,this.readyState=WebSocket.CONNECTING,this.protocol=null;var a,s=this,d=!1,l=!1,u=document.createElement("div");u.addEventListener("open",function(e){s.onopen(e)}),u.addEventListener("close",function(e){s.onclose(e)}),u.addEventListener("connecting",function(e){s.onconnecting(e)}),u.addEventListener("message",function(e){s.onmessage(e)}),u.addEventListener("error",function(e){s.onerror(e)}),this.addEventListener=u.addEventListener.bind(u),this.removeEventListener=u.removeEventListener.bind(u),this.dispatchEvent=u.dispatchEvent.bind(u),this.open=function(t){if(a=new WebSocket(s.url,n||[]),t){if(this.maxReconnectAttempts&&this.reconnectAttempts>this.maxReconnectAttempts)return}else u.dispatchEvent(c("connecting")),this.reconnectAttempts=0;(s.debug||e.debugAll)&&console.debug("ReconnectingWebSocket","attempt-connect",s.url);var o=a,i=setTimeout(function(){(s.debug||e.debugAll)&&console.debug("ReconnectingWebSocket","connection-timeout",s.url),l=!0,o.close(),l=!1},s.timeoutInterval);a.onopen=function(n){clearTimeout(i),(s.debug||e.debugAll)&&console.debug("ReconnectingWebSocket","onopen",s.url),s.protocol=a.protocol,s.readyState=WebSocket.OPEN,s.reconnectAttempts=0;var o=c("open");o.isReconnect=t,t=!1,u.dispatchEvent(o)},a.onclose=function(n){if(clearTimeout(i),a=null,d)s.readyState=WebSocket.CLOSED,u.dispatchEvent(c("close"));else{s.readyState=WebSocket.CONNECTING;var o=c("connecting");o.code=n.code,o.reason=n.reason,o.wasClean=n.wasClean,u.dispatchEvent(o),t||l||((s.debug||e.debugAll)&&console.debug("ReconnectingWebSocket","onclose",s.url),u.dispatchEvent(c("close")));var i=s.reconnectInterval*Math.pow(s.reconnectDecay,s.reconnectAttempts);setTimeout(function(){s.reconnectAttempts++,s.open(!0)},i>s.maxReconnectInterval?s.maxReconnectInterval:i)}},a.onmessage=function(t){(s.debug||e.debugAll)&&console.debug("ReconnectingWebSocket","onmessage",s.url,t.data);var n=c("message");n.data=t.data,u.dispatchEvent(n)},a.onerror=function(t){(s.debug||e.debugAll)&&console.debug("ReconnectingWebSocket","onerror",s.url,t),u.dispatchEvent(c("error"))}},1==this.automaticOpen&&this.open(!1),this.send=function(t){if(a)return(s.debug||e.debugAll)&&console.debug("ReconnectingWebSocket","send",s.url,t),a.send(t);throw"INVALID_STATE_ERR : Pausing to reconnect websocket"},this.close=function(e,t){void 0===e&&(e=1e3),d=!0,a&&a.close(e,t)},this.refresh=function(){a&&a.close()}}if("WebSocket"in window)return e.prototype.onopen=function(e){},e.prototype.onclose=function(e){},e.prototype.onconnecting=function(e){},e.prototype.onmessage=function(e){},e.prototype.onerror=function(e){},e.debugAll=!1,e.CONNECTING=WebSocket.CONNECTING,e.OPEN=WebSocket.OPEN,e.CLOSING=WebSocket.CLOSING,e.CLOSED=WebSocket.CLOSED,e})},{}],2:[function(e,t,n){e("reconnectingwebsocket");t.exports=function(e){function t(){n.socket.onopen=function(){n.connected=!0,n.sendMyDetails(),document.dispatchEvent(new CustomEvent("dataclient-connected",{detail:{sender:n}}))},n.socket.onmessage=function(e){var t=JSON.parse(e.data);"peers"==t.msg?function(e){var t={},o=[],c=!1,i=!0;if(n.me.id||(c=!0),n.me.id=e.id,c)n.sendMyDetails();else{for(a=0;a<n.peers.length;a++){var r=e.peers.find(function(e){return e.id==n.peers[a].id});r?r.name&&!n.peers[a].name&&(console.log("[DataClient] User "+r.id+" set username:",r.name),console.log("[DataClient] Peers after username update:",e.peers)):(o.push(n.peers[a]),console.log("[DataClient] Peer disconnected:",n.peers[a]),e.sourceId==n.peers[a]&&(t=n.peers[a]))}0==n.peers.length&&0!=e.peers.length&&(console.log("[DataClient] Initial list of peers received from server:",e.peers),i=!1);for(var a=0;a<e.peers.length;a++)e.sourceId==e.peers[a].id&&(t=e.peers[a]),i&&!n.peers.find(function(t){return t.id==e.peers[a].id})&&(console.log("[DataClient] Peer connected:",e.peers[a]),console.log("[DataClient] Peers after new user:",e.peers));n.peers=e.peers,document.dispatchEvent(new CustomEvent("dataclient-peers",{detail:{sender:n,source:t,removedPeers:o}}))}}(t.data):"selection"==t.msg?function(e){console.log("[DataClient] Peer selection received.",e);var t=n.peers.find(function(t){return t.id==e.id});t&&(t.range=e.range,document.dispatchEvent(new CustomEvent("dataclient-cursor-update",{detail:{sender:n,source:t}})))}(t.data):"content"==t.msg?function(e){console.log("[DataClient] Received document content."),n.version=e.version,document.dispatchEvent(new CustomEvent("dataclient-content",{detail:{sender:n,data:e.content}}))}(t.data):"delta"==t.msg&&function(e){console.log("[DataClient] Received document delta."),n.version=e.version,document.dispatchEvent(new CustomEvent("dataclient-delta",{detail:{sender:n,data:e.delta}}))}(t.data)},n.socket.onclose=function(e){console.log("[DataClient] Socket closed. Event:",e),n.connected=!1,document.dispatchEvent(new CustomEvent("dataclient-disconnected",{detail:{sender:n}}))},n.socket.onerror=function(e){console.log("[DataClient] Error on socket. Event:",e)}}var n={};return n.codeName="dc",n.color="red",n.me=null,n.connected=!1,n.version=null,n.peers=[],n.connect=function(e){n.me=new function(e,t){this.id=null,this.name=e,this.color=t}(e,n.color);var o=("https:"===location.protocol?"wss":"ws")+"://"+window.location.host+"/data";n.socket=new WebSocket(o),t()},n.disconnect=function(){n.socket.close(),delete n.socket,delete n.me,n.peers=[]},n.sendMyDetails=function(){var e={msg:"details",data:n.me};n.socket.send(JSON.stringify(e))},n.selectionChanged=function(e){if(n.me){n.me.range=e;var t={msg:"selection",data:n.me.range};n.socket.send(JSON.stringify(t))}},n.contentChanged=function(e,t,o){if("user"==o){n.me.range&&n.me.range.length&&(n.me.range.index+=n.me.range.length,n.me.range.length=0,n.selectionChanged());var c={msg:"delta",data:e};n.socket.send(JSON.stringify(c))}},n}},{reconnectingwebsocket:1}],3:[function(e,t,n){function o(e,t,n){var o={},c=0==Object.keys(t.cursors).length;n.peers.forEach(function(i){i.id!=n.me.id&&((i.id==e.id||c)&&i.range&&t.setCursor(i.id,i.range,i.name,i.color),o[i.id]=i)}),Object.keys(t.cursors).forEach(function(e){o[e]||t.removeCursor(e)})}var c=["red","blue","violet","green","orchid","orange"],i=e("./utils"),r=e("./data-client")();r.codeName="dc1";var a=e("./data-client")();a.codeName="dc2";var s,d,l,u,f={theme:"snow",placeholder:"Let's write a story together.",modules:{cursors:{autoRegisterListener:!1},history:{userOnly:!0}},readOnly:!0};$(document).ready(function(){Quill.register("modules/cursors",QuillCursors),s=new Quill("#editorL",f),d=new Quill("#editorR",f),$(".editorWrap").removeClass("hidden"),function(){function e(e,t,n){c.forEach(function(e){return t.removeClass(e)});var o=Math.abs(i.hash(e.val()))%6;t.addClass(c[o]),n.color=c[o]}var t=$(".half.left .connect input[type='text']"),n=$(".half.left .connect input[type='button']");e(t,n,r),t.on("input",function(){e(t,n,r)});var o=$(".half.right .connect input[type='text']"),s=$(".half.right .connect input[type='button']");e(o,s,a),o.on("input",function(){e(o,s,a)})}(),function(e){e.forEach(function(e){var t=e[0],n=e[1],o=n.find(".connect input[type='button']"),c=n.find(".connect input[type='text']");o.click(function(){if(!$(this).hasClass("disabled")){if(t.connected)t.disconnect();else{var e=c.val();t.codeName,t.connect(e)}$(this).addClass("disabled"),c.prop("readonly",!0)}})}),document.addEventListener("dataclient-connected",function(e,t){var n=null;"dc1"==e.detail.sender.codeName?(n=$(".half.left .connect input[type='button']"),s.enable(),o(r.me,l,r)):(n=$(".half.right .connect input[type='button']"),d.enable(),o(a.me,u,a)),n.attr("value","Disconnect"),n.removeClass("disabled")}),document.addEventListener("dataclient-disconnected",function(e){var t,n;"dc1"==e.detail.sender.codeName?(t=$(".half.left .connect input[type='button']"),n=$(".half.left .connect input[type='text']"),s.disable()):(t=$(".half.right .connect input[type='button']"),n=$(".half.right .connect input[type='text']"),d.disable()),t.attr("value","Connect"),t.removeClass("disabled"),n.prop("readonly",!1)}),document.addEventListener("dataclient-peers",function(e){"dc1"==e.detail.sender.codeName?o(e.detail.source,l,r):"dc2"==e.detail.sender.codeName&&o(e.detail.source,u,a)})}([[r,$(".half.left")],[a,$(".half.right")]]),(l=s.getModule("cursors")).registerTextChangeListener(),(u=d.getModule("cursors")).registerTextChangeListener(),s.on("selection-change",function(e,t,n){r.selectionChanged(e)}),d.on("selection-change",function(e,t,n){a.selectionChanged(e)}),document.addEventListener("dataclient-cursor-update",function(e){"dc1"==e.detail.sender.codeName?o(e.detail.source,l,r):"dc2"==e.detail.sender.codeName&&o(e.detail.source,u,a)}),s.on("text-change",function(e,t,n){r.contentChanged(e,t,n)}),d.on("text-change",function(e,t,n){a.contentChanged(e,t,n)}),document.addEventListener("dataclient-content",function(e){var t;"dc1"==e.detail.sender.codeName?t=s:"dc2"==e.detail.sender.codeName&&(t=d),t.setContents(e.detail.data)}),document.addEventListener("dataclient-delta",function(e){var t;"dc1"==e.detail.sender.codeName?t=s:"dc2"==e.detail.sender.codeName&&(t=d),t.updateContents(e.detail.data)})})},{"./data-client":2,"./utils":4}],4:[function(e,t,n){n.debounce=function(e,t,n){var o;return function(){var c=this,i=arguments,r=n&&!o;clearTimeout(o),o=setTimeout(function(){o=null,n||e.apply(c,i)},t),r&&e.apply(c,i)}},n.hash=function(e){for(var t=0,n=0,o=e.length;n<o;)t=(t<<5)-t+e.charCodeAt(n++)<<0;return t}},{}]},{},[3]);
//# sourceMappingURL=app.js.map
